# AciTrack Backend API

A production-ready FastAPI service that exposes academic publication data from Google Drive for consumption by Custom GPT Actions.

## Overview

AciTrack Backend provides HTTPS endpoints to access the latest academic publication reports, manifests, and CSV data generated by the AciTrack system. The data is stored in Google Drive and accessed via a service account.

## Features

- ✅ **Simple REST API** - Three GET endpoints for easy access
- ✅ **Google Drive Integration** - Automatic file retrieval from Google Drive
- ✅ **Custom GPT Ready** - OpenAPI 3.0.1 schema included
- ✅ **Production Deploy** - Ready for Railway or Render
- ✅ **Health Monitoring** - Built-in health check endpoint
- ✅ **CORS Configured** - Secure access from OpenAI domains
- ✅ **Zero Per-User Auth** - Service account based authentication

## Quick Start

### Prerequisites

- Python 3.11+
- Google Cloud Service Account with Drive API access
- Google Drive folder ID containing the files

### Local Development

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd acitracker_backend
   ```

2. **Create virtual environment**
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Set environment variables**
   ```bash
   export ACITRACK_DRIVE_FOLDER_ID="your-folder-id"
   export ACITRACK_GCP_SA_JSON='{"type":"service_account",...}'
   ```

5. **Run the server**
   ```bash
   python main.py
   ```

6. **Test locally**
   ```bash
   curl http://localhost:8000/health
   curl http://localhost:8000/report
   ```

## API Endpoints

### `GET /`
Returns API information and available endpoints.

**Response**: `application/json`

### `GET /health`
Health check endpoint for monitoring service status.

**Response**: `application/json`
```json
{
  "status": "healthy",
  "drive_connected": true,
  "folder_name": "AciTrack Outputs",
  "folder_id": "abc123..."
}
```

### Original Endpoints (No caching)

### `GET /report`
Returns the latest academic publication report in Markdown format.

**Response**: `text/markdown`

**File**: `latest_report.md`

### `GET /manifest`
Returns the latest manifest with publication metadata.

**Response**: `application/json`

**File**: `latest_manifest.json`

### `GET /new`
Returns CSV of newly discovered publications.

**Response**: `text/csv`

**File**: `latest_new.csv`

### New Cached Endpoints

The following endpoints use intelligent caching (10-minute TTL by default) and automatically fall back to stale cache if Google Drive is unavailable.

### `GET /api/must-reads`
Returns must-read publications in JSON format.

**Response**: `application/json`

**File**: `latest_must_reads.json`

**Caching**: Yes (10 min TTL, stale fallback)

### `GET /api/must-reads/md`
Returns must-read publications in Markdown format.

**Response**: `text/markdown`

**File**: `latest_must_reads.md`

**Caching**: Yes (10 min TTL, stale fallback)

### `GET /api/summaries`
Returns publication summaries in JSON format.

**Response**: `application/json`

**File**: `latest_summaries.json`

**Caching**: Yes (10 min TTL, stale fallback)

### `GET /api/db/snapshot`
Download the latest database snapshot as a gzipped SQLite file.

**Response**: `application/gzip` (downloadable)

**File**: `latest_db.sqlite.gz`

**Caching**: Yes (10 min TTL, stale fallback)

### `GET /api/artifacts/status`
Returns status information for all artifacts including cache status and Drive availability.

**Response**: `application/json`

**Example**:
```json
{
  "status": "ok",
  "cache_ttl_minutes": 10,
  "artifacts": {
    "must_reads_json": {
      "filename": "latest_must_reads.json",
      "available": true,
      "file_id": "1abc...",
      "cache": {
        "cached": true,
        "cached_at": "2025-12-30T10:30:00",
        "is_valid": true,
        "ttl_minutes": 10
      }
    }
  }
}
```

## Deployment

See **[DEPLOYMENT.md](DEPLOYMENT.md)** for detailed deployment instructions for:
- Railway (recommended)
- Render

## Custom GPT Integration

1. Deploy the backend to Railway or Render
2. Copy your deployment URL
3. Update `openapi.json` with your server URL
4. In ChatGPT → GPT Builder → Actions:
   - Paste the contents of `openapi.json`
   - Save
5. Test your Custom GPT

## Project Structure

```
acitracker_backend/
├── main.py              # FastAPI application
├── requirements.txt     # Python dependencies
├── openapi.json        # OpenAPI schema for Custom GPT
├── DEPLOYMENT.md       # Deployment guide
├── SECURITY.md         # Security documentation
├── README.md           # This file
└── .gitignore          # Git ignore rules
```

## Configuration

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ACITRACK_DRIVE_FOLDER_ID` | Yes | Google Drive folder ID containing output files |
| `ACITRACK_GCP_SA_JSON` | Yes | Service account JSON as a single-line string |
| `ACITRACK_CACHE_TTL_MINUTES` | No | Cache TTL in minutes (default: 10) |
| `PORT` | No | Port to run server (default: 8000, auto-set by platforms) |

### Required Files in Google Drive

The Google Drive folder must contain these exact filenames:

**Original files:**
- `latest_report.md`
- `latest_manifest.json`
- `latest_new.csv`

**New files (for cached endpoints):**
- `latest_must_reads.json`
- `latest_must_reads.md`
- `latest_summaries.json`
- `latest_db.sqlite.gz`

## Security

- Service account has **read-only** access to Google Drive
- HTTPS enforced by deployment platform
- CORS configured for OpenAI domains only
- No sensitive data in responses

See **[SECURITY.md](SECURITY.md)** for comprehensive security documentation.

## Architecture

```
┌─────────────┐
│ Custom GPT  │
└──────┬──────┘
       │ HTTPS
       ▼
┌─────────────────┐
│  FastAPI Server │
│  (Railway/      │
│   Render)       │
└────────┬────────┘
         │ Google Drive API
         ▼
┌──────────────────┐
│  Google Drive    │
│  Folder          │
│  ├── latest_     │
│  │   report.md   │
│  ├── latest_     │
│  │   manifest.json│
│  └── latest_new.csv│
└──────────────────┘
```

## Monitoring

### Health Check

Monitor service health by pinging:
```bash
curl https://your-app-url/health
```

### Uptime Monitoring

Set up free monitoring with:
- [UptimeRobot](https://uptimerobot.com)
- [Better Uptime](https://betteruptime.com)

Configure to check `/health` every 5 minutes.

## Troubleshooting

### Common Issues

**"File not found in Google Drive folder"**
- Verify folder ID is correct
- Check files exist with exact names
- Ensure service account has viewer access to folder

**"Invalid JSON in ACITRACK_GCP_SA_JSON"**
- Ensure JSON is valid and properly escaped
- Copy entire service account JSON as single line
- Remove any line breaks or extra whitespace

**"Google Drive API error: 403"**
- Service account needs read access
- Share folder with service account email
- Check service account has Drive API enabled

See [DEPLOYMENT.md](DEPLOYMENT.md) for more troubleshooting tips.

## Performance

### Response Times
- Cold start (free tier): 10-30 seconds
- Warm requests: 200-500ms
- Drive API latency: 100-300ms

### Optimization Opportunities
- Add caching (Redis) to reduce Drive API calls
- Upgrade to paid tier to eliminate cold starts
- Implement CDN for static content

## Cost Estimates

### Railway
- Free tier: $5/month credit (sufficient for low traffic)
- Paid tier: ~$10-20/month for production

### Render
- Free tier: 750 hours/month (sufficient for demo)
- Paid tier: ~$7-15/month for production

### Google Cloud
- Drive API: Free (within quota limits)
- Storage: Free (minimal data)

## Roadmap

### Phase 1: MVP (Current)
- ✅ Basic API endpoints
- ✅ Google Drive integration
- ✅ OpenAPI schema
- ✅ Deployment ready

### Phase 2: Enhancements
- [ ] Request logging
- [ ] Response caching
- [ ] Rate limiting
- [ ] API key authentication

### Phase 3: Production
- [ ] Monitoring & alerts
- [ ] Automatic key rotation
- [ ] Custom domain
- [ ] Performance optimization

## Contributing

This is an internal SpotItEarly project. For changes:

1. Create a feature branch
2. Make your changes
3. Test locally
4. Deploy to staging (if available)
5. Create pull request

## Testing

### Local Testing

After starting the server locally (`python main.py`), test the endpoints:

#### 1. Test Health and Status
```bash
# Health check
curl http://localhost:8000/health

# Check artifacts status (cache info)
curl http://localhost:8000/api/artifacts/status
```

#### 2. Test Original Endpoints (No caching)
```bash
# Get report (Markdown)
curl -v http://localhost:8000/report

# Get manifest (JSON)
curl http://localhost:8000/manifest | jq .

# Get new publications (CSV)
curl http://localhost:8000/new
```

#### 3. Test New Cached Endpoints

**Must-reads JSON:**
```bash
# First request (cache miss, fetches from Drive)
curl -v http://localhost:8000/api/must-reads

# Second request within 10 min (cache hit)
curl -v http://localhost:8000/api/must-reads

# Check Content-Type header is application/json
curl -I http://localhost:8000/api/must-reads
```

**Must-reads Markdown:**
```bash
# Get must-reads as Markdown
curl -v http://localhost:8000/api/must-reads/md

# Verify Content-Type: text/markdown
curl -I http://localhost:8000/api/must-reads/md
```

**Summaries JSON:**
```bash
# Get summaries
curl http://localhost:8000/api/summaries | jq .

# Verify Content-Type: application/json
curl -I http://localhost:8000/api/summaries
```

**Database Snapshot (gzip):**
```bash
# Download the gzipped database
curl -o latest_db.sqlite.gz http://localhost:8000/api/db/snapshot

# Verify it's a valid gzip file
gunzip -t latest_db.sqlite.gz

# If valid, extract it
gunzip latest_db.sqlite.gz

# Verify it's a SQLite database
file latest_db.sqlite
sqlite3 latest_db.sqlite ".tables"

# Verify Content-Type and Content-Disposition headers
curl -I http://localhost:8000/api/db/snapshot
# Should see:
# Content-Type: application/gzip
# Content-Disposition: attachment; filename=latest_db.sqlite.gz
```

#### 4. Test Caching Behavior

```bash
# First request - should download from Drive
curl -v http://localhost:8000/api/must-reads 2>&1 | grep "X-Cache"

# Second request (within 10 min) - should use cache
curl -v http://localhost:8000/api/must-reads 2>&1 | grep "X-Cache"

# Check cache status
curl http://localhost:8000/api/artifacts/status | jq '.artifacts.must_reads_json.cache'
```

#### 5. Test Stale Cache Fallback

To test fallback behavior, you can temporarily rename a file in Drive or disconnect from the internet:

```bash
# After disabling Drive access or internet
curl -v http://localhost:8000/api/must-reads

# Should see headers:
# X-Cache-Status: stale
# X-Error: Drive API unavailable
```

### Production Testing (Render/Railway)

Replace `http://localhost:8000` with your deployed URL:

```bash
# Set your deployment URL
DEPLOY_URL="https://your-app.onrender.com"

# Test health
curl $DEPLOY_URL/health

# Test new endpoints
curl $DEPLOY_URL/api/must-reads | jq .
curl $DEPLOY_URL/api/summaries | jq .
curl -I $DEPLOY_URL/api/must-reads/md
curl -o db.sqlite.gz $DEPLOY_URL/api/db/snapshot && gunzip -t db.sqlite.gz

# Check artifacts status
curl $DEPLOY_URL/api/artifacts/status | jq .
```

### Verification Checklist for Render Deployment

After deploying to Render, verify:

- [ ] `/health` endpoint returns `"status": "healthy"`
- [ ] `/api/artifacts/status` shows all files as available
- [ ] `/api/must-reads` returns valid JSON
- [ ] `/api/must-reads/md` returns Markdown with `Content-Type: text/markdown`
- [ ] `/api/summaries` returns valid JSON
- [ ] `/api/db/snapshot` downloads a valid gzip file
- [ ] Second request to cached endpoint is faster (check response time)
- [ ] Cache status shows `"cached": true` after first request
- [ ] All responses have correct `Content-Type` headers

### Performance Testing

```bash
# Test response time without cache
time curl -s http://localhost:8000/api/must-reads > /dev/null

# Test response time with cache (should be faster)
time curl -s http://localhost:8000/api/must-reads > /dev/null

# Load test (requires apache-bench)
ab -n 100 -c 10 http://localhost:8000/api/must-reads
```

## Support

For issues:
1. Check [DEPLOYMENT.md](DEPLOYMENT.md) troubleshooting section
2. Review platform logs (Railway/Render dashboard)
3. Test `/health` endpoint
4. Test `/api/artifacts/status` for cache and Drive connectivity
5. Contact team lead

## License

Internal use only - SpotItEarly

## Credits

Built with:
- [FastAPI](https://fastapi.tiangolo.com/) - Modern Python web framework
- [Google Drive API](https://developers.google.com/drive) - File storage
- [Railway](https://railway.app) / [Render](https://render.com) - Deployment platforms

---

**Status**: ✅ Production Ready

**Last Updated**: 2025-12-26

**Maintained By**: SpotItEarly Engineering Team
